name: iOS Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'App version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-release:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode 26.2
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'
      
    - name: Show Xcode version
      run: xcodebuild -version
        
    # Для подписи приложения нужны сертификаты и профили
    # Раскомментируйте и настройте, если у вас есть Apple Developer аккаунт
    
    # - name: Import Code Signing Certificate
    #   uses: apple-actions/import-codesign-certs@v2
    #   with:
    #     p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
    #     p12-password: ${{ secrets.CERTIFICATES_PASSWORD }}
    #
    # - name: Install Provisioning Profile
    #   uses: apple-actions/download-provisioning-profiles@v1
    #   with:
    #     app-store-connect-api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
    #     app-store-connect-issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
    #     app-store-connect-api-key-content: ${{ secrets.APPSTORE_API_KEY_CONTENT }}
    #     bundle-ids: 'ru.k-connect.konnectapp'  # Замените на ваш Bundle ID
      
    - name: Build iOS app (Release for Device)
      run: |
        # Собираем для реального устройства (arm64)
        # ВАЖНО: GENERATE_INFOPLIST_FILE=NO чтобы использовать наш Info.plist
        xcodebuild clean build \
          -project konnectapp.xcodeproj \
          -scheme konnectapp \
          -configuration Release \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          IPHONEOS_DEPLOYMENT_TARGET=18.0 \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          GENERATE_INFOPLIST_FILE=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -derivedDataPath ./build
          
    - name: Verify build architecture and Info.plist
      run: |
        APP_PATH=$(find ./build -name "konnectapp.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "konnectapp.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -n "$APP_PATH" ]; then
          echo "Found app at: $APP_PATH"
          
          # Проверяем архитектуру
          echo "Checking architecture..."
          lipo -info "$APP_PATH/konnectapp" || file "$APP_PATH/konnectapp"
          
          # КРИТИЧНО: Проверяем Info.plist
          echo "Checking Info.plist..."
          if [ -f "$APP_PATH/Info.plist" ]; then
            echo "✅ Info.plist exists"
            echo "Info.plist contents:"
            plutil -p "$APP_PATH/Info.plist" | head -15
          else
            echo "❌ ERROR: Info.plist NOT FOUND in .app bundle!"
            exit 1
          fi
          
          # Проверяем, что нет переменных в Info.plist
          if grep -q "\$(" "$APP_PATH/Info.plist" 2>/dev/null; then
            echo "❌ ERROR: Info.plist contains unresolved variables!"
            grep "\$(" "$APP_PATH/Info.plist"
            exit 1
          else
            echo "✅ Info.plist contains real values (no variables)"
          fi
        else
          echo "❌ App not found"
          exit 1
        fi
        
    - name: Create IPA from Release build
      run: |
        APP_PATH=$(find ./build -name "konnectapp.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "App not found in build/, searching in DerivedData..."
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "konnectapp.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -n "$APP_PATH" ]; then
          echo "Found app at: $APP_PATH"
          
          # Проверяем, что это сборка для устройства, а не симулятора
          ARCH=$(lipo -info "$APP_PATH/konnectapp" 2>/dev/null || echo "")
          if echo "$ARCH" | grep -q "simulator"; then
            echo "❌ ERROR: App is built for simulator, not device!"
            echo "Architecture: $ARCH"
            exit 1
          fi
          
          # КРИТИЧНО: Проверяем и копируем Info.plist явно, если его нет
          echo "Checking Info.plist in .app bundle..."
          if [ ! -f "$APP_PATH/Info.plist" ]; then
            echo "⚠️ WARNING: Info.plist not found in .app bundle!"
            echo "Attempting to copy Info.plist manually..."
            if [ -f "konnectapp/Info.plist" ]; then
              cp "konnectapp/Info.plist" "$APP_PATH/Info.plist"
              echo "✅ Copied Info.plist to .app bundle"
            else
              echo "❌ CRITICAL: Source Info.plist not found at konnectapp/Info.plist!"
              find . -name "Info.plist" -type f
              exit 1
            fi
          fi
          
          # Проверяем содержимое
          echo "Validating Info.plist contents..."
          if grep -q "\$(" "$APP_PATH/Info.plist" 2>/dev/null; then
            echo "❌ CRITICAL: Info.plist contains unresolved variables!"
            grep "\$(" "$APP_PATH/Info.plist"
            exit 1
          fi
          
          # Показываем первые строки для проверки
          echo "Info.plist preview:"
          plutil -p "$APP_PATH/Info.plist" | head -10
          
          mkdir -p ./artifacts/Payload
          cp -R "$APP_PATH" ./artifacts/Payload/konnectapp.app
          
          # Проверяем, что Info.plist скопировался
          if [ ! -f "./artifacts/Payload/konnectapp.app/Info.plist" ]; then
            echo "❌ CRITICAL: Info.plist not copied to Payload!"
            exit 1
          fi
          
          # Создаем .ipa файл
          echo "Creating .ipa file..."
          cd ./artifacts
          zip -r konnectapp-release.ipa Payload
          cd ..
          echo "✅ Created konnectapp-release.ipa"
          ls -lh ./artifacts/
          
          # Финальная проверка Info.plist в .ipa
          echo "Verifying Info.plist in .ipa..."
          unzip -q -o ./artifacts/konnectapp-release.ipa -d /tmp/ipa_check
          if [ -f "/tmp/ipa_check/Payload/konnectapp.app/Info.plist" ]; then
            echo "✅ Info.plist found in .ipa"
            plutil -p /tmp/ipa_check/Payload/konnectapp.app/Info.plist | head -10
          else
            echo "❌ CRITICAL: Info.plist NOT in .ipa file!"
            exit 1
          fi
        else
          echo "❌ App not found"
          exit 1
        fi
          
    - name: Upload Release IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: konnectapp-release-ipa
        path: artifacts/konnectapp-release.ipa
        retention-days: 30
        if-no-files-found: error

